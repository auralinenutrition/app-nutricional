{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 146, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/kaiky/OneDrive/%C3%81rea%20de%20Trabalho/Auraline/app-nutricional/src/lib/supabase/server.ts"],"sourcesContent":["import { cookies } from \"next/headers\";\r\nimport { createServerClient } from \"@supabase/ssr\";\r\n\r\nexport async function createServerSupabase() {\r\n  const cookieStore = await cookies();\r\n\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get(name: string) {\r\n          return cookieStore.get(name)?.value;\r\n        },\r\n        set(name: string, value: string, options?: any) {\r\n          try {\r\n            cookieStore.set(name, value, options);\r\n          } catch {\r\n            // ignore erro em GET\r\n          }\r\n        },\r\n        remove(name: string, options?: any) {\r\n          try {\r\n            cookieStore.delete({ name, ...options });\r\n          } catch {\r\n            // ignore erro em GET\r\n          }\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;AAAA;AACA;AAAA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,CAAA,GAAA,iIAAA,CAAA,UAAO,AAAD;IAEhC,OAAO,CAAA,GAAA,2KAAA,CAAA,qBAAkB,AAAD,sUAGtB;QACE,SAAS;YACP,KAAI,IAAY;gBACd,OAAO,YAAY,GAAG,CAAC,OAAO;YAChC;YACA,KAAI,IAAY,EAAE,KAAa,EAAE,OAAa;gBAC5C,IAAI;oBACF,YAAY,GAAG,CAAC,MAAM,OAAO;gBAC/B,EAAE,OAAM;gBACN,qBAAqB;gBACvB;YACF;YACA,QAAO,IAAY,EAAE,OAAa;gBAChC,IAAI;oBACF,YAAY,MAAM,CAAC;wBAAE;wBAAM,GAAG,OAAO;oBAAC;gBACxC,EAAE,OAAM;gBACN,qBAAqB;gBACvB;YACF;QACF;IACF;AAEJ","debugId":null}},
    {"offset": {"line": 185, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/kaiky/OneDrive/%C3%81rea%20de%20Trabalho/Auraline/app-nutricional/src/app/api/ai/generate-plan/route.ts"],"sourcesContent":["// src/app/api/ai/generate-plan/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport OpenAI from \"openai\";\r\nimport { createServerSupabase } from \"@/lib/supabase/server\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst SUPABASE_SERVICE_ROLE = process.env.SUPABASE_SERVICE_ROLE_KEY!;\r\n\r\nconst supabaseAdmin = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE, {\r\n  auth: { persistSession: false },\r\n});\r\n\r\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\r\nconst MODEL = process.env.OPENAI_MODEL ?? \"gpt-4o-mini\";\r\n\r\nfunction safeExtractJson(text: string) {\r\n  if (!text) return null;\r\n  const match = text.match(/\\{[\\s\\S]*\\}/);\r\n  if (!match) return null;\r\n\r\n  try {\r\n    return JSON.parse(match[0]);\r\n  } catch {\r\n    try {\r\n      const cleaned = match[0].replace(/\\s+/g, \" \");\r\n      return JSON.parse(cleaned);\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n}\r\n\r\n/* -----------------------------------------------------\r\n   FUNÇÃO CRÍTICA: NORMALIZA TUDO QUE A IA GERA\r\n------------------------------------------------------ */\r\nfunction normalizeWeek(rawWeek: any) {\r\n  const days = [\r\n    \"domingo\",\r\n    \"segunda\",\r\n    \"terca\",\r\n    \"quarta\",\r\n    \"quinta\",\r\n    \"sexta\",\r\n    \"sabado\",\r\n  ];\r\n\r\n  const normalizeMeal = (item: any) => {\r\n    if (typeof item === \"string\") {\r\n      return {\r\n        title: item,\r\n        description: \"\",\r\n        calories: 0,\r\n      };\r\n    }\r\n\r\n    return {\r\n      title: String(item?.title ?? \"\"),\r\n      description: String(item?.description ?? \"\"),\r\n      calories: Number(item?.calories ?? 0),\r\n    };\r\n  };\r\n\r\n  const finalWeek: any = {};\r\n\r\n  for (const day of days) {\r\n    const raw = rawWeek?.[day] ?? [];\r\n    finalWeek[day] = Array.isArray(raw) ? raw.map(normalizeMeal) : [];\r\n  }\r\n\r\n  return finalWeek;\r\n}\r\n\r\n/* -----------------------------------------------------\r\n   ROTA PRINCIPAL\r\n------------------------------------------------------ */\r\nexport async function POST() {\r\n  try {\r\n    const supabase = await createServerSupabase();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n    }\r\n\r\n    const userId = user.id;\r\n\r\n    // buscar quiz\r\n    const { data: quiz } = await supabase\r\n      .from(\"quiz_responses\")\r\n      .select(\"*\")\r\n      .eq(\"user_id\", userId)\r\n      .order(\"created_at\", { ascending: false })\r\n      .limit(1)\r\n      .single();\r\n\r\n    if (!quiz) {\r\n      return NextResponse.json({ error: \"Quiz not found\" }, { status: 400 });\r\n    }\r\n\r\n    // prompt IA\r\n    const prompt = `\r\nGere APENAS UM JSON. \r\nFormato obrigatório:\r\n\r\n{\r\n  \"metas\": { \"meta_agua\": number, \"meta_calorias\": number, \"meta_refeicoes\": number },\r\n  \"week\": {\r\n    \"domingo\": [...],\r\n    \"segunda\": [...],\r\n    \"terca\": [...],\r\n    \"quarta\": [...],\r\n    \"quinta\": [...],\r\n    \"sexta\": [...],\r\n    \"sabado\": [...]\r\n  },\r\n  \"shopping_list\": [\"...\"]\r\n}\r\n\r\nCada refeição DEVE SER um objeto:\r\n{\r\n  \"title\": \"...\",\r\n  \"description\": \"\",\r\n  \"calories\": 0\r\n}\r\n\r\nQuiz:\r\n${JSON.stringify(quiz)}\r\n`;\r\n\r\n    const aiResp = await openai.chat.completions.create({\r\n      model: MODEL,\r\n      temperature: 0.1,\r\n      max_tokens: 1400,\r\n      messages: [\r\n        { role: \"system\", content: \"Você é um nutricionista especialista.\" },\r\n        { role: \"user\", content: prompt },\r\n      ],\r\n    });\r\n\r\n    const rawText = aiResp.choices[0]?.message?.content ?? \"\";\r\n    const parsed = safeExtractJson(rawText);\r\n\r\n    if (!parsed) {\r\n      return NextResponse.json({ error: \"Invalid AI JSON\" }, { status: 500 });\r\n    }\r\n\r\n    // NORMALIZAÇÃO FUNDAMENTAL\r\n    const finalWeek = normalizeWeek(parsed.week);\r\n\r\n    const plan = {\r\n      metas: {\r\n        meta_agua: Number(parsed.metas?.meta_agua ?? 2000),\r\n        meta_calorias: Number(parsed.metas?.meta_calorias ?? 2000),\r\n        meta_refeicoes: Number(parsed.metas?.meta_refeicoes ?? 4),\r\n      },\r\n      week: finalWeek,\r\n      shopping_list: parsed.shopping_list ?? [],\r\n    };\r\n\r\n    // salvar no banco\r\n    const { data: saved, error: saveErr } = await supabaseAdmin\r\n      .from(\"ai_generated_plans\")\r\n      .insert([\r\n        {\r\n          user_id: userId,\r\n          plan_type: \"weekly_meal_plan\",\r\n          content: plan,\r\n        },\r\n      ])\r\n      .select()\r\n      .single();\r\n\r\n    if (saveErr) {\r\n      console.error(\"save plan error:\", saveErr);\r\n      return NextResponse.json(\r\n        { error: \"Failed to save plan\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Atualizar metas no users\r\n    await supabaseAdmin\r\n      .from(\"users\")\r\n      .update({\r\n        meta_agua: plan.metas.meta_agua,\r\n        meta_calorias: plan.metas.meta_calorias,\r\n        meta_refeicoes: plan.metas.meta_refeicoes,\r\n      })\r\n      .eq(\"id\", userId);\r\n\r\n    return NextResponse.json({ success: true, plan_id: saved.id, plan });\r\n  } catch (err: any) {\r\n    console.error(\"generate-plan error:\", err);\r\n    return NextResponse.json({ error: err.message }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}